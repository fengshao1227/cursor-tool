# 验证开关使用说明

## 🔓 功能说明

已添加验证开关功能，可以通过一个环境变量 `DISABLE_LICENSE_CHECK` 来控制是否需要验证。

- **开启验证**（默认）：需要激活卡密才能使用
- **关闭验证**：无需卡密，直接使用所有功能

## 📝 使用方法

### 方法一：使用 npm 脚本（推荐）

**打包无验证版本：**
```bash
# 打包所有平台的无验证版本
npm run dist:no-license

# 打包 Mac 无验证版本
npm run dist:no-license:mac

# 打包 Windows 无验证版本
npm run dist:no-license:win
```

**打包有验证版本（默认）：**
```bash
# 打包所有平台的有验证版本
npm run dist

# 打包 Mac 有验证版本
npm run dist:mac

# 打包 Windows 有验证版本
npm run dist:win
```

### 方法二：手动设置环境变量

**Windows (PowerShell):**
```powershell
$env:DISABLE_LICENSE_CHECK="true"
npm run build
npm run dist
```

**Windows (CMD):**
```cmd
set DISABLE_LICENSE_CHECK=true
npm run build
npm run dist
```

**Mac/Linux:**
```bash
export DISABLE_LICENSE_CHECK=true
npm run build
npm run dist
```

### 方法三：在代码中直接修改

如果需要永久禁用验证，可以直接修改 `src/main/license-service.ts`：

```typescript
// 将这行改为 true 即可永久禁用验证
const DISABLE_LICENSE_CHECK = true  // 改为 true
```

## 🔍 实现原理

验证开关在 `src/main/license-service.ts` 中实现：

```typescript
// 🔓 验证开关：设置为 true 时禁用验证（用于打包无验证版本）
const DISABLE_LICENSE_CHECK = process.env.DISABLE_LICENSE_CHECK === 'true' || process.env.DISABLE_LICENSE_CHECK === '1'
```

当 `DISABLE_LICENSE_CHECK` 为 `true` 时：
- `getStatus()` 直接返回 `{ valid: true }`
- `ensureLicensed()` 直接返回 `{ success: true }`
- 不会进行任何验证检查
- 不会显示卡密激活界面

## ✅ 验证位置

验证开关会影响以下位置：

1. **`license-service.ts`**
   - `getStatus()` - 获取许可证状态
   - `ensureLicensed()` - 确保已授权

2. **`index.ts`**
   - `getLicenseStatus` IPC 处理器

3. **`App.tsx`**
   - `checkLicense()` - 启动时检查许可证

## 🎯 使用场景

### 场景一：开发测试
```bash
# 开发时禁用验证，方便测试
export DISABLE_LICENSE_CHECK=true
npm run dev
```

### 场景二：打包无验证版本
```bash
# 打包给内部使用或测试的无验证版本
npm run dist:no-license:win
```

### 场景三：打包有验证版本
```bash
# 打包正式版本，需要卡密验证
npm run dist:win
```

## ⚠️ 注意事项

1. **环境变量优先级**
   - 环境变量 `DISABLE_LICENSE_CHECK` 优先级最高
   - 如果设置为 `true` 或 `1`，验证会被禁用

2. **构建时设置**
   - 环境变量需要在**构建时**设置
   - 运行时设置环境变量不会生效（因为代码已经编译）

3. **跨平台兼容**
   - 使用 `cross-env` 包确保跨平台兼容
   - Windows、Mac、Linux 都可以使用相同的命令

4. **版本区分**
   - 建议在版本号或文件名中区分有验证和无验证版本
   - 例如：`v1.0.3-no-license.exe` vs `v1.0.3.exe`

## 📦 打包示例

### 打包无验证版本
```bash
# 1. 安装依赖（如果还没有安装 cross-env）
npm install

# 2. 打包无验证版本
npm run dist:no-license:win

# 3. 输出文件在 release/ 目录
```

### 打包有验证版本
```bash
# 1. 确保环境变量未设置或为 false
unset DISABLE_LICENSE_CHECK  # Mac/Linux
# 或
set DISABLE_LICENSE_CHECK=   # Windows CMD

# 2. 打包有验证版本
npm run dist:win

# 3. 输出文件在 release/ 目录
```

## 🔧 代码位置

- **开关定义：** `src/main/license-service.ts` 第 44 行
- **验证逻辑：** `src/main/license-service.ts` 第 361-384 行（getStatus）
- **授权检查：** `src/main/license-service.ts` 第 386-417 行（ensureLicensed）

## ✅ 总结

通过设置 `DISABLE_LICENSE_CHECK=true` 环境变量，可以轻松打包无验证版本：

1. ✅ **一个变量控制**：只需设置一个环境变量
2. ✅ **简单易用**：提供了便捷的 npm 脚本
3. ✅ **跨平台兼容**：使用 cross-env 确保跨平台支持
4. ✅ **不影响代码**：不需要修改代码，只需设置环境变量

**推荐使用方式：**
```bash
# 无验证版本
npm run dist:no-license:win

# 有验证版本
npm run dist:win
```

